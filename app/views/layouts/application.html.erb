<!DOCTYPE html>
<html>
  <head>
    <title>DeskShare</title>
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/themes/base/jquery-ui.min.css" %>
    <%= stylesheet_link_tag "https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" %>
    <%= stylesheet_link_tag "https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.css" %>
    
    <!-- jQuery를 먼저 로드 -->
    <%= javascript_include_tag "https://code.jquery.com/jquery-3.7.1.min.js", crossorigin: "anonymous", integrity: "sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" %>
    
    <!-- Raty를 jQuery 로드 후에 로드 -->
    <%= javascript_include_tag "https://cdnjs.cloudflare.com/ajax/libs/raty/2.7.1/jquery.raty.min.js", crossorigin: "anonymous" %>
    
    <%= javascript_importmap_tags %>
    <script>
      window.RATY_STAR_ON = "<%= asset_path('star-on.png') %>";
      window.RATY_STAR_OFF = "<%= asset_path('star-off.png') %>";
      window.RATY_STAR_HALF = "<%= asset_path('star-half.png') %>";
    </script>
    <%= javascript_include_tag "https://maps.googleapis.com/maps/api/js?key=#{ ENV['MAPS_API_KEY']}&libraries=places&loading=async",
                            async: true,
                            defer: true,
                            "data-turbo-eval": false %>
    <%= favicon_link_tag asset_path('orangePolygonLarge.png') %>
    
    <!-- Raty 초기화를 위한 전역 스크립트 -->
    <script>
      console.log('[Raty Layout Debug] Layout script loaded');
      
      // 전역 raty 초기화 함수 (fallback)
      window.initializeRatyGlobally = window.initializeRatyGlobally || function() {
        console.log('[Raty Layout Debug] Fallback initializeRatyGlobally called');
        if (typeof window.$ !== 'undefined' && typeof window.$.fn.raty !== 'undefined') {
          const starElements = document.querySelectorAll('.star-rating:not(.raty-initialized)');
          console.log('[Raty Layout Debug] Found', starElements.length, 'star elements to initialize');
          
          starElements.forEach((element, index) => {
            const score = element.getAttribute('data-score') || 0;
            const imagePath = '/assets/';
            
            try {
              window.$(element).raty({
                readOnly: true,
                score: score,
                starOff: imagePath + 'star-off.png',
                starOn: imagePath + 'star-on.png',
                starHalf: imagePath + 'star-half.png',
                size: 24,
                hints: ['1 star', '2 stars', '3 stars', '4 stars', '5 stars']
              });
              element.classList.add('raty-initialized');
              console.log(`[Raty Layout Debug] Successfully initialized element ${index + 1}`);
            } catch (error) {
              console.error(`[Raty Layout Debug] Error initializing element ${index + 1}:`, error);
            }
          });
        }
      };
      
      // 전역 raty 안정화 함수 (fallback)
      window.ensureRatyInitialized = window.ensureRatyInitialized || function() {
        console.log('[Raty Layout Debug] Fallback ensureRatyInitialized called');
        let attempts = 0;
        const maxAttempts = 10;
        
        function tryInitialize() {
          if (typeof window.$ !== 'undefined' && typeof window.$.fn.raty !== 'undefined') {
            window.initializeRatyGlobally();
          } else if (attempts < maxAttempts) {
            attempts++;
            setTimeout(tryInitialize, 300);
          }
        }
        
        tryInitialize();
      };
      
      // 직접적인 raty 초기화 함수 (가장 안정적)
      function initializeAllRatyElements() {
        console.log('[Raty Layout Debug] Direct initialization called');
        if (typeof window.$ !== 'undefined' && typeof window.$.fn.raty !== 'undefined') {
          const starElements = document.querySelectorAll('.star-rating:not(.raty-initialized)');
          console.log('[Raty Layout Debug] Direct init - Found', starElements.length, 'star elements');
          
          starElements.forEach((element, index) => {
            const score = element.getAttribute('data-score') || 0;
            const imagePath = '/assets/';
            
            console.log(`[Raty Layout Debug] Direct init - Element ${index + 1}:`, {
              element: element,
              score: score,
              imagePath: imagePath
            });
            
            try {
              window.$(element).raty({
                readOnly: true,
                score: score,
                starOff: imagePath + 'star-off.png',
                starOn: imagePath + 'star-on.png',
                starHalf: imagePath + 'star-half.png',
                size: 24,
                hints: ['1 star', '2 stars', '3 stars', '4 stars', '5 stars']
              });
              element.classList.add('raty-initialized');
              console.log(`[Raty Layout Debug] Direct init - Successfully initialized element ${index + 1}`);
            } catch (error) {
              console.error(`[Raty Layout Debug] Direct init - Error initializing element ${index + 1}:`, error);
            }
          });
        } else {
          console.log('[Raty Layout Debug] Direct init - Dependencies not available');
        }
      }
      
      // jQuery와 Raty가 로드된 후 전역 초기화 함수 실행
      window.addEventListener('load', function() {
        console.log('[Raty Layout Debug] Window load event fired');
        setTimeout(initializeAllRatyElements, 100);
      });
      
      // 프로덕션에서 추가적인 초기화 보장
      document.addEventListener('DOMContentLoaded', function() {
        console.log('[Raty Layout Debug] DOMContentLoaded event fired in layout');
        setTimeout(initializeAllRatyElements, 200);
      });
      
      // Turbo 이벤트에 대한 추가 처리
      document.addEventListener('turbo:load', function() {
        console.log('[Raty Layout Debug] turbo:load event fired in layout');
        setTimeout(initializeAllRatyElements, 100);
      });
      
      // jQuery와 Raty 로딩 상태 확인
      document.addEventListener('DOMContentLoaded', function() {
        console.log('[Raty Layout Debug] Checking jQuery and Raty availability:', {
          jquery: typeof window.$,
          raty: typeof window.$.fn?.raty,
          jqueryVersion: window.$?.fn?.jquery,
          ratyVersion: window.$.fn?.raty ? 'available' : 'not available'
        });
      });
    </script>
  </head>

  <body>
    <%# navbar %>
    <%= render 'shared/navbar' %>      
  
    <%# main %>
    <%= render 'shared/message'%>
    <div class="container main" id="main">

      <%= yield %>

    </div>
    <div id="footer">
      <footer class="pt-4 my-md-5 pt-md-5 border-top">
        <div class="row">
          <div class="col-12 col-md">
          <a class="navbar-brand" href="/pages/home"> <%= image_tag "orangeLogoLarge.png", class: "mb-2", alt:"logo", style: "width: 200px" %></a>         
            <small class="d-block mb-3 text-muted">&copy; <%= Date.current.year %></small>
          </div>
          <div class="col-6 col-md">
            <h5 class="mb-2">Features</h5>
            <ul class="list-unstyled text-small">
              <%= link_to new_user_session_path, class: "text-muted mb-2" do %><li class="mb-1">Log in </li><% end %>
              <%= link_to new_user_registration_path, class: "text-muted " do %><li class="mb-1">Sign up </li><% end %>
              <%= link_to search_path(q: {"address_cont": @location_received }) do %><li class="mb-1 text-muted">Advanced Search</li><% end %>
              <%= link_to search_path(q: {"address_cont": @location_received }) do %><li class="mb-1 text-muted">Local Search</li><% end %>
              <%= link_to new_room_path, class: "text-muted" do %><li class="mb-1">Hosting New Location </li><% end %>
              <%= link_to edit_user_registration_path, class: "text-muted " do %><li class="mb-1">Profile Update </li><% end %>
              <%= link_to rooms_path, class: "text-muted " do %><li class="mb-1">Your Hosting List</li><% end %>
              <%= link_to yourlisting_reservations_path, class: "text-muted " do %><li class="mb-1">Your Customer Reservation</li><% end %>
              <%= link_to your_trips_path, class: "text-muted " do %><li class="mb-1">Your Cart</li><% end %>
            </ul>
          </div>
          <div class="col-6 col-md">
            <h5 class="mb-2">Resources</h5>
            <ul class="list-unstyled text-small">
              <li class="mb-2">Photos from <a class="text-muted" href="https://www.pexels.com/" target="_blank">Pexels</a></li>
              <%= link_to attribution_path, class: "text-muted", target: "_blank" do %><li class="mb-2">Photo Artists</li><% end %>
              <li class="mb-2">People vector Created by <a class="text-muted" href="https://www.freepik.com/vectors/people" target="_blank"> Freepik</a></li>
              <li class="mb-2">Logo Design Created with <a class="text-muted" href="https://www.LogoMakr.com" target="_blank"> LogoMakr</a></li>
          
            </ul>
          </div>
          <div class="col-6 col-md">
            <h5 class="mb-2">About</h5>
            <ul class="list-unstyled text-small">
              <li><div class="text-muted mt-2 mb-4 d-flex"><a href="https://devneolee.github.io/justinklee/" target="_blank"><span class="mr-1">© Justin K Lee </span><%= image_tag "blueplane_icon.svg", width: "25px", class: "blueplane"%> </a></div></li>
              <li class="mb-4"><a target="_blank" href="https://github.com/devneoLee" ><span class="mr-2">GitHub</span><i class="fab fa-github fa-lg"></i></a></li>      								       
              <li class="mt-2 mb-4"><a target="_blank" href="https://www.linkedin.com/in/justinklee215/"><span class="mr-2">LinkedIn</span><i class="fab fa-linkedin fa-lg"></i></a></li>
            </ul>
          </div>
        </div>
      </footer>    
    </div>
  </body>
</html>
