<!-- Star rating CSS is now centralized in site.scss -->

<script>
  document.addEventListener('DOMContentLoaded', function() {
    console.log('[Star Rating Debug] Initializing pure CSS star ratings (search)');
    
    // Initialize all star rating elements
    document.querySelectorAll('.star-rating').forEach(function(element, index) {
      const score = parseFloat(element.dataset.score) || 0;
      
      // Round to nearest 0.5 for better display
      const roundedScore = Math.round(score * 2) / 2;
      element.setAttribute('data-score', roundedScore);
      
      console.log(`[Star Rating Debug] Element ${index + 1} initialized with score: ${roundedScore}`);
    });
    
    console.log('[Star Rating Debug] Pure CSS star ratings completed (search)');
  });
</script>

<div class="h2 mb-4">
  <% if params[:q] && params[:q]["address_cont"].present? %>
    Search results for "<%= params[:q]["address_cont"] %>"
  <% else %>
    View All Spaces
  <% end %>
</div>

<div id="complex_search" class="card m-3 p-3 shadow ">
    <div class="d-flex justify-content-end align-items-center mb-3">
        <button id="complex_search_button" class="btn btn-secondary">Advanced Search</button>
    </div>

    <div id="complex_search_menu" class="invisible col-md-12">
       
        <div class="mt-3">
            <%= search_form_for @browse, url: search_path do |f| %>
                <div class="row mb3">
                    <div class="col-md-6">
                        Location: <%=f.search_field :address_cont, class: "form-control input-lg mr-sm-2", placeholder: "Where are you going?", id: "search_location" %>
                    </div>
                    <div class="col-md-3 ">
                        Start Date: <%= text_field_tag :start_date, nil, {placeholder: "Start Date", id: "start_date", class: "form-control"}%>
                    </div>
                    <div class="col-md-3">
                        End Date: <%= text_field_tag :end_date, nil, placeholder: "End Date", class: "form-control", id: "end_date"%>
                    </div>
                </div>
                <hr>
                <div class="row mt-3">
                    <div class="col-md-3">
                        Space Name: <%= f.text_field :listing_name, placeholder: "Listing Name", class: "form-control"%>
                    </div>
                </div>
                <hr>
                <div class="row mt-3">
                    <div class="col-md-3">
                        Price(min $) <%= f.number_field :price_gteq, placeholder: "min price", class: "form-control", id: "price_min"%>
                    </div>
                    <div class="col-md-3">
                        (max $)<%= f.number_field :price_lteq, placeholder: "max price", class: "form-control", id: "price_max"%>
                    </div>
                </div>
                <hr>      
                <div class="row">
                    <span class="col-md-2">Space Type: </span>
                    <div class="col-md-3">
                        <%= check_box_tag "q[space_type_eq_any][]", "Apartment", false, id: "space_type_apartment"%> Apartment <i class="far fa-building"></i>
                    </div>
                    <div class="col-md-3">
                        <%= check_box_tag "q[space_type_eq_any][]", "House", false, id: "space_type_house"%> House <i class="fas fa-house-user"></i>
                    </div>
                    <div class="col-md-3">
                        <%= check_box_tag "q[space_type_eq_any][]", "Office", false, id: "space_type_office"%> Office <i class="fas fa-briefcase"></i>
                    </div>                
                </div>
                <hr>
                <div class="row">
                    <span class="col-md-2">Desk Type: </span>
                    <div class="col-md-3">
                        <%= check_box_tag "q[desk_type_eq_any][]", "Single Desk", false, id: "desk_type_single"%> Single Desk <i class="far fa-user"></i>
                    </div>
                    <div class="col-md-3">
                        <%= check_box_tag "q[desk_type_eq_any][]", "Private Room Office", false, id: "desk_type_private"%> Private Room Office <i class="fas fa-person-booth"></i>
                    </div>
                    <div class="col-md-3">
                        <%= check_box_tag "q[desk_type_eq_any][]", "Sharing Table", false, id: "desk_type_sharing"%> Sharing Table <i class="fas fa-users"></i>
                    </div>                
                </div>
                <hr>
                 <div class="row">
                    <span class="col-md-2">Noise Level: </span>
                    <div class="col-md-3">
                        <%= check_box_tag "q[noise_level_eq_any][]", "Silent Mode", false, id: "noise_silent"%> Silent Mode <i class="fas fa-volume-mute"></i>
                    </div>
                    <div class="col-md-3">
                        <%= check_box_tag "q[noise_level_eq_any][]", "Quiet", false, id: "noise_quiet"%> Quiet <i class="fas fa-volume-off"></i>
                    </div>
                    <div class="col-md-3">
                        <%= check_box_tag "q[noise_level_eq_any][]", "Casual", false, id: "noise_casual"%> Casual <i class="fas fa-volume-down"></i>
                    </div>                
                </div>
                <hr>
                <div class="row">
                    <span class="col-md-2">Manager on Premise: </span>
                    <div class="col-md-3">
                        <%= check_box_tag "q[manager_on_eq_any][]", "Fulltime", false, id: "manager_fulltime"%> Fulltime <i class="fas fa-user-shield"></i>
                    </div>
                    <div class="col-md-3">
                        <%= check_box_tag "q[manager_on_eq_any][]", "Parttime", false, id: "manager_parttime"%> Parttime <i class="fas fa-user-clock"></i>
                    </div>
                    <div class="col-md-3">
                        <%= check_box_tag "q[manager_on_eq_any][]", "No Stay", false, id: "manager_nostay"%> No Stay <i class="fas fa-comment-slash"></i>
                    </div>                
                </div>
                <hr>
                <div class="row">
                    <span class="col-md-2">Security Level: </span>
                    <div class="col-md-3">
                        <%= check_box_tag "q[security_level_eq_any][]", "Maximum", false, id: "security_maximum"%> Maximum <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="col-md-3">
                        <%= check_box_tag "q[security_level_eq_any][]", "High", false, id: "security_high"%> High <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="col-md-3">
                        <%= check_box_tag "q[security_level_eq_any][]", "Good", false, id: "security_good"%> Good <i class="fas fa-shield-alt"></i>
                    </div>                
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>How many seats needed?</label>
                            <%= f.number_field :capacity_gteq, class: "form-control", placeholder: "How many people?" %>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Bathrooms</label>
                            <%= f.select :bath_room_gteq, [["1",1], ["2",2], ["3",3], ["4+",4]], prompt: "Need more bathrooms?", class: "form-control"%>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row pl-3 pb-3">
                        Amenity: 
                    </div>
                <div class="row">
                    <div class="col-md-4 mb-2">
                        <%= check_box_tag "q[is_conference_eq]", true, false, id: "amenity_conference"%> Conference Call <i class="fas fa-headset ml-3"></i>
                    </div>
                    <div class="col-md-4 mb-2">
                        <%= check_box_tag "q[is_kitchen_eq]", true, false, id: "amenity_kitchen"%> Kitchen <i class="fas fa-sink ml-3"></i>
                    </div>
                    <div class="col-md-4 mb-2">
                        <%= check_box_tag "q[is_wifi_eq]", true, false, id: "amenity_wifi"%> Wifi <i class="fas fa-wifi ml-3 mb-1"></i>
                    </div>
                    <div class="col-md-4 mb-2">
                        <%= check_box_tag "q[is_heating_eq]", true, false, id: "amenity_heating"%> Heating <i class="fas fa-fire ml-3"></i>
                    </div>
                    <div class="col-md-4 mb-2">
                        <%= check_box_tag "q[is_air_eq]", true, false, id: "amenity_air"%> Air Condition <i class="fas fa-fan ml-3"></i>
                    </div>
                    <div class="col-md-4 mb-2">
                        <%= check_box_tag "q[is_printing_eq]", true, false, id: "amenity_printing"%> Printing Station <i class="fas fa-print ml-3"></i>
                    </div>
                    <div class="col-md-4 mb-2">
                        <%= check_box_tag "q[is_drinks_eq]", true, false, id: "amenity_drinks"%> Free Drinks <i class="fas fa-print ml-3"></i>
                    </div>
                    <div class="col-md-4 mb-2">
                        <%= check_box_tag "q[is_parking_eq]", true, false, id: "amenity_parking"%> parking <i class="fas fa-parking ml-3"></i>
                    </div>           
                </div>
                <br>
                <div class="row">
                    <div class="col-md-4">
                        <%= f.submit "Search", class: "btn btn-primary"%>
                    </div>
                </div>
            <% end %>
        </div>

    </div>
</div>

<% if @browse_result.empty? %>
    <div class="text-center py-5">
        <div class="alert alert-info">
            <h4>No search results found</h4>
            <p>Try different search criteria:</p>
            <ul class="list-unstyled">
                <li>• Try a different location name</li>
                <li>• Adjust the price range</li>
                <li>• Change the space type</li>
                <li>• Use advanced search</li>
            </ul>
            <%= link_to "View All Spaces", search_path, class: "btn btn-primary mt-3" %>
        </div>
    </div>
<% else %>
    <div data-controller="infinite-scroll" data-action="scroll@window->infinite-scroll#scroll">
        <div class="row search-results-row" data-infinite-scroll-target="entries">
            <%= render 'rooms/rooms'%> 
        </div>
        <div data-infinite-scroll-target="pagination" class="pagination_type">
            <%== pagy_bootstrap_nav(@pagy_search).html_safe %>
        </div>
    </div>
<% end %>
  
<script>
    // Wait for jQuery UI to be fully loaded
    function initializeSearchDatepickers() {
        if (typeof $ !== 'undefined' && typeof $.fn.datepicker !== 'undefined') {
            // Advanced search button toggle
            $('#complex_search_button').on('click', function() {
                if ($('#complex_search_menu').hasClass('visible')) {
                    $('#complex_search_menu').removeClass('visible').addClass('invisible');
                } else {
                    $('#complex_search_menu').removeClass('invisible').addClass('visible');
                    // Clear form fields when opening
                    $('#search_location').val('');
                    $('#listing_name').val('');
                    $('#start_date').val('');
                    $('#end_date').val('');
                    $('#price_min').val('');
                    $('#price_max').val('');
                }
            });

            // Initialize datepickers
            $('#start_date').datepicker({
                dateFormat: 'dd-mm-yy',
                minDate: 0,
                maxDate: '3m',
                onSelect: function(select) {
                    $('#end_date').datepicker("option", "minDate", select);
                    $('#end_date').attr('disabled', false);
                }
            });
      
            $('#end_date').datepicker({
                dateFormat: 'dd-mm-yy',
                minDate: 0,
                maxDate: '3m',
                onSelect: function(select) {
                    $('#start_date').datepicker("option", "maxDate", select);
                }
            });
            
            // Form validation
            $('form').on('submit', function(e) {
                var startDate = $('#start_date').val();
                var endDate = $('#end_date').val();
                
                if (startDate && !endDate) {
                    e.preventDefault();
                    alert('Please select an end date.');
                    return false;
                }
                
                if (endDate && !startDate) {
                    e.preventDefault();
                    alert('Please select a start date.');
                    return false;
                }
            });
            
        } else {
            // Retry after a short delay
            setTimeout(initializeSearchDatepickers, 100);
        }
    }
    
    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        initializeSearchDatepickers();
    });
    
    // Also try with jQuery ready when available
    if (typeof $ !== 'undefined') {
        $(function() {
            initializeSearchDatepickers();
        });
    }
</script>


